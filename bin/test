#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: vulkan-cts.test <test-spec>"
    echo ""
    echo "Examples:"
    echo "  vulkan-cts.test --deqp-case=dEQP-VK.info.build"
    echo "  vulkan-cts.test --caselist=mustpass/main/vk-default/api.txt"
    echo "  vulkan-cts.test dEQP-VK.info.build"
    exit 1
fi

# Set up Vulkan ICD and libraries from gpu-2404 content interface
if [ -d "${SNAP}/gpu-2404" ]; then
    case "${SNAP_ARCH}" in
        amd64) GPU_ARCH=x86_64;  ARCH_TRIPLE=x86_64-linux-gnu ;;
        arm64) GPU_ARCH=aarch64; ARCH_TRIPLE=aarch64-linux-gnu ;;
        *)     GPU_ARCH="${SNAP_ARCH}"; ARCH_TRIPLE="${SNAP_ARCH}-linux-gnu" ;;
    esac
    export VK_ICD_FILENAMES
    VK_ICD_FILENAMES=$(ls "${SNAP}/gpu-2404/usr/share/vulkan/icd.d/"*"${GPU_ARCH}"*.json 2>/dev/null | tr '\n' ':')
    export LD_LIBRARY_PATH="${SNAP}/gpu-2404/usr/lib/${ARCH_TRIPLE}${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
fi

# Create a working directory for test results
WORK_DIR="${HOME}/.vulkan-cts"
mkdir -p "${WORK_DIR}"

# deqp resolves data paths relative to CWD, so run from the data root.
cd "${SNAP}/usr/share/vulkan-cts"

if [[ "$1" == --caselist=* ]]; then
    CASELIST_PATH="${1#--caselist=}"
    CASELIST_FULL="${SNAP}/usr/share/vulkan-cts/${CASELIST_PATH}"
    "${SNAP}/usr/bin/deqp-vk" \
        --deqp-caselist-file="${CASELIST_FULL}" \
        --deqp-log-filename="${WORK_DIR}/$(basename "${CASELIST_PATH}" .txt).qpa"
elif [[ "$1" == --deqp-case=* ]]; then
    "${SNAP}/usr/bin/deqp-vk" "$1" \
        --deqp-log-filename="${WORK_DIR}/TestResults.qpa"
else
    "${SNAP}/usr/bin/deqp-vk" --deqp-case="$1" \
        --deqp-log-filename="${WORK_DIR}/TestResults.qpa"
fi
