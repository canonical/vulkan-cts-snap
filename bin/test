#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: vulkan-cts.test <test-spec>"
    echo ""
    echo "Examples:"
    echo "  vulkan-cts.test --deqp-case=dEQP-VK.info.build"
    echo "  vulkan-cts.test --caselist=mustpass/main/vk-default/api.txt"
    echo "  vulkan-cts.test dEQP-VK.info.build"
    exit 1
fi

# Set up Vulkan ICD and libraries from gpu-2404 content interface
if [ -d "${SNAP}/gpu-2404" ]; then
    case "${SNAP_ARCH}" in
        amd64) GPU_ARCH=x86_64;  ARCH_TRIPLE=x86_64-linux-gnu ;;
        arm64) GPU_ARCH=aarch64; ARCH_TRIPLE=aarch64-linux-gnu ;;
        *)     GPU_ARCH="${SNAP_ARCH}"; ARCH_TRIPLE="${SNAP_ARCH}-linux-gnu" ;;
    esac
    export VK_ICD_FILENAMES
    VK_ICD_FILENAMES=$(ls "${SNAP}/gpu-2404/usr/share/vulkan/icd.d/"*"${GPU_ARCH}"*.json 2>/dev/null | tr '\n' ':')
    export LD_LIBRARY_PATH="${SNAP}/gpu-2404/usr/lib/${ARCH_TRIPLE}${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}"
fi

# Create a working directory for test results
WORK_DIR="${HOME}/.vulkan-cts"
mkdir -p "${WORK_DIR}"
cd "${WORK_DIR}"

run_deqp() {
    # Stream output unchanged but override exit based on the final "Failed:" summary count.
    "$@" 2>&1 | awk '
        {
            print
            if ($1 == "Failed:") {
                split($2, parts, "/")
                failed = parts[1]
                found = 1
            }
        }
        END {
            if (found && failed + 0 > 0) {
                exit 1
            }
            exit 0
        }
    '
    return $?
}

# Parse the argument and run deqp-vk accordingly
if [[ "$1" == --caselist=* ]]; then
    # Extract the caselist path
    CASELIST_PATH="${1#--caselist=}"
    CASELIST_FULL="${SNAP}/usr/share/vulkan-cts/${CASELIST_PATH}"
    # deqp resolves sub-caselist files relative to CWD, so cd to the caselist's directory
    cd "$(dirname "${CASELIST_FULL}")"
    run_deqp "${SNAP}/usr/bin/deqp-vk" \
        --deqp-caselist-file="${CASELIST_FULL}" \
        --deqp-log-filename=/dev/null
elif [[ "$1" == --deqp-case=* ]]; then
    # Pass through as-is
    run_deqp "${SNAP}/usr/bin/deqp-vk" "$1"
else
    # Assume it's a bare test case name
    run_deqp "${SNAP}/usr/bin/deqp-vk" --deqp-case="$1"
fi
